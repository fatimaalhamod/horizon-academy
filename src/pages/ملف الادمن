// src/pages/TrainerDashboard.js
import React, { useState } from "react";

const TrainerDashboard = ({ navigateTo, currentUser, courses, setCourses }) => {
  const [activeTab, setActiveTab] = useState("courses");
  const [selectedCourse, setSelectedCourse] = useState(null);
  const [showAddLevelModal, setShowAddLevelModal] = useState(false);
  const [showAddLectureModal, setShowAddLectureModal] = useState(false);
  const [showAddQuizModal, setShowAddQuizModal] = useState(false);
  const [showEditCourseModal, setShowEditCourseModal] = useState(false);
  const [showEditProfileModal, setShowEditProfileModal] = useState(false);
  const [showChangePasswordModal, setShowChangePasswordModal] = useState(false);

  // بيانات المدرب
  const [trainerInfo, setTrainerInfo] = useState({
    name: currentUser.name,
    email: currentUser.email,
    phone: currentUser.phone || "",
    bio: currentUser.bio || "لا يوجد وصف شخصي بعد.",
    avatar: currentUser.avatar || "https://picsum.photos/200/200"
  });

  // بيانات إضافة مستوى
  const [newLevel, setNewLevel] = useState({ title: "", description: "" });

  // بيانات إضافة محاضرة
  const [newLecture, setNewLecture] = useState({
    title: "",
    videoUrl: "",
    levelId: ""
  });

  // بيانات إضافة سؤال اختبار
  const [newQuiz, setNewQuiz] = useState({
    question: "",
    options: ["", "", "", ""],
    correctAnswer: 0,
    levelId: ""
  });

  // بيانات تعديل دورة
  const [editingCourse, setEditingCourse] = useState({});

  // بيانات تعديل الملف الشخصي
  const [editTrainer, setEditTrainer] = useState({ ...trainerInfo });

  // بيانات تغيير كلمة المرور
  const [currentPassword, setCurrentPassword] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');

  // الدورات الخاصة بالمدرب فقط
  const trainerCourses = courses.filter(course => course.instructor.email === currentUser.email);

  // دالة إضافة مستوى
  const handleAddLevel = () => {
    if (!newLevel.title) {
      alert("يرجى إدخال عنوان المستوى");
      return;
    }

    const safeLevels = Array.isArray(selectedCourse.levels) ? selectedCourse.levels : [];

    const updatedCourse = {
      ...selectedCourse,
      levels: [
        ...safeLevels,
        {
          id: safeLevels.length + 1,
          ...newLevel,
          lectures: [],
          quiz: []
        }
      ]
    };

    setCourses(courses.map(c => c.id === selectedCourse.id ? updatedCourse : c));
    setSelectedCourse(updatedCourse);
    setNewLevel({ title: "", description: "" });
    setShowAddLevelModal(false);
  };

  // دالة إضافة محاضرة
  const handleAddLecture = () => {
    if (!newLecture.title || !newLecture.videoUrl || !newLecture.levelId) {
      alert("يرجى تعبئة جميع الحقول");
      return;
    }

    const levelId = parseInt(newLecture.levelId);
    const updatedCourse = { ...selectedCourse };
    const level = updatedCourse.levels?.find(l => l.id === levelId);

    if (level) {
      level.lectures = level.lectures || [];
      level.lectures.push({
        id: level.lectures.length + 1,
        ...newLecture
      });

      setCourses(courses.map(c => c.id === selectedCourse.id ? updatedCourse : c));
      setSelectedCourse(updatedCourse);
    }

    setNewLecture({ title: "", videoUrl: "", levelId: "" });
    setShowAddLectureModal(false);
  };

  // دالة إضافة سؤال اختبار
  const handleAddQuiz = () => {
    if (!newQuiz.question || newQuiz.options.some(opt => !opt)) {
      alert("يرجى تعبئة جميع الحقول");
      return;
    }

    const levelId = parseInt(newQuiz.levelId);
    const updatedCourse = { ...selectedCourse };
    const level = updatedCourse.levels?.find(l => l.id === levelId);

    if (level) {
      level.quiz = level.quiz || [];
      level.quiz.push({
        id: level.quiz.length + 1,
        ...newQuiz
      });

      setCourses(courses.map(c => c.id === selectedCourse.id ? updatedCourse : c));
      setSelectedCourse(updatedCourse);
    }

    setNewQuiz({ question: "", options: ["", "", "", ""], correctAnswer: 0, levelId: "" });
    setShowAddQuizModal(false);
  };

  // دالة تعديل تفاصيل الدورة
  const handleEditCourse = () => {
    if (!editingCourse.title || !editingCourse.description) {
      alert("يرجى تعبئة الحقول المطلوبة");
      return;
    }
    const updatedCourse = { ...selectedCourse, ...editingCourse };
    setCourses(courses.map(c => c.id === selectedCourse.id ? updatedCourse : c));
    setSelectedCourse(updatedCourse);
    setShowEditCourseModal(false);
  };

  // دالة تعديل الملف الشخصي
  const handleEditProfile = () => {
    setTrainerInfo({ ...editTrainer });
    setEditTrainer({ ...editTrainer });

    // تحديث currentUser
    const updatedUser = { ...currentUser, ...editTrainer };
    localStorage.setItem("currentUser", JSON.stringify(updatedUser));

    setShowEditProfileModal(false);
    alert("تم تحديث الملف الشخصي بنجاح!");
  };

  // دالة تغيير كلمة المرور
  const handleChangePassword = () => {
    const users = JSON.parse(localStorage.getItem("users")) || [];
    const user = users.find(u => u.email === currentUser.email);

    if (user.password !== currentPassword) {
      alert("كلمة المرور الحالية غير صحيحة");
      return;
    }

    if (newPassword !== confirmPassword) {
      alert("كلمة المرور غير متطابقة");
      return;
    }

    if (newPassword.length < 6) {
      alert("كلمة المرور يجب أن تكون 6 أحرف على الأقل");
      return;
    }

    user.password = newPassword;
    localStorage.setItem("users", JSON.stringify(users));
    alert("تم تغيير كلمة المرور بنجاح!");
    setShowChangePasswordModal(false);
  };

  return (
    <div className="min-h-screen bg-gray-50 flex">
      {/* الشريط الجانبي */}
      <aside className="w-64 bg-indigo-800 text-white min-h-screen p-6">
        <div className="mb-8">
          <h1 className="text-2xl font-bold">لوحة المدرب</h1>
          <p className="text-indigo-200">مرحباً، {currentUser?.name}</p>
        </div>
        <nav className="space-y-2">
          <button
            onClick={() => setActiveTab("courses")}
            className={`w-full text-right px-4 py-2 rounded-lg transition ${
              activeTab === "courses" ? "bg-indigo-600" : "hover:bg-indigo-700"
            }`}
          >
            دوراتي
          </button>
          <button
            onClick={() => setActiveTab("profile")}
            className={`w-full text-right px-4 py-2 rounded-lg transition ${
              activeTab === "profile" ? "bg-indigo-600" : "hover:bg-indigo-700"
            }`}
          >
            ملفي الشخصي
          </button>
        </nav>
      </aside>

      {/* المحتوى الرئيسي */}
      <main className="flex-1 p-8">
        {/* الهيدر */}
        <header className="bg-white shadow-sm mb-8 p-6 rounded-lg flex justify-between items-center">
          <h2 className="text-2xl font-bold text-gray-800">لوحة تحكم المدرب</h2>
          <button
            onClick={() => navigateTo("home")}
            className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition"
          >
            تسجيل الخروج
          </button>
        </header>

        {/* إدارة الدورات */}
        {activeTab === "courses" && (
          <div>
            <h2 className="text-2xl font-bold mb-6">دوراتك</h2>
            {trainerCourses.length === 0 ? (
              <p>ليس لديك دورات بعد. راجع المدير لتعيينك.</p>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {trainerCourses.map(course => (
                  <div key={course.id} className="bg-white rounded-lg shadow-md p-6">
                    <img src={course.image} alt={course.title} className="w-full h-32 object-cover rounded-lg mb-4" />
                    <h3 className="text-lg font-bold">{course.title}</h3>
                    <p className="text-sm text-gray-600">المستويات: {course.levels?.length || 0}</p>
                    <p className="text-sm text-gray-600">المحاضرات: {course.levels?.reduce((acc, level) => acc + (level.lectures?.length || 0), 0) || 0}</p>
                    <button
                      onClick={() => setSelectedCourse(course)}
                      className="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg w-full"
                    >
                      إدارة الدورة
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* ملف المدرب الشخصي */}
        {activeTab === "profile" && (
          <div className="bg-white rounded-lg shadow-md p-6 max-w-4xl mx-auto">
            <div className="flex items-center space-x-6 mb-6">
              <img
                src={trainerInfo.avatar}
                alt="صورة المدرب"
                className="w-24 h-24 rounded-full object-cover border-4 border-indigo-500"
              />
              <div>
                <h2 className="text-2xl font-bold">{trainerInfo.name}</h2>
                <p className="text-gray-600">{trainerInfo.email}</p>
                <p className="text-gray-600">{trainerInfo.phone}</p>
              </div>
            </div>

            <div className="mb-6">
              <h3 className="text-lg font-bold mb-2">نبذة عن المدرب</h3>
              <p className="text-gray-700">{trainerInfo.bio}</p>
            </div>

            <div className="flex space-x-4">
              <button
                onClick={() => {
                  setEditTrainer({ ...trainerInfo });
                  setShowEditProfileModal(true);
                }}
                className="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg"
              >
                تعديل الملف الشخصي
              </button>
              <button
                onClick={() => setShowChangePasswordModal(true)}
                className="bg-black text-white px-6 py-2 rounded-lg"
              >
                تغيير كلمة المرور
              </button>
            </div>
          </div>
        )}

        {/* إدارة الدورة المحددة */}
        {selectedCourse && (
          <div className="mt-8 bg-white rounded-lg shadow-md p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold">إدارة: {selectedCourse.title}</h3>
              <button
                onClick={() => setSelectedCourse(null)}
                className="text-gray-500 hover:text-gray-700"
              >
                ✕ إغلاق
              </button>
            </div>

            {/* تعديل تفاصيل الدورة */}
            <div className="mb-6">
              <h4 className="font-bold mb-2">تعديل تفاصيل الدورة</h4>
              <button
                onClick={() => {
                  setEditingCourse({ ...selectedCourse });
                  setShowEditCourseModal(true);
                }}
                className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg"
              >
                تعديل التفاصيل
              </button>
            </div>

            {/* إضافة مستوى */}
            <div className="mb-6">
              <h4 className="font-bold mb-2">إضافة مستوى</h4>
              <button
                onClick={() => setShowAddLevelModal(true)}
                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg"
              >
                إضافة مستوى جديد
              </button>
            </div>

            {/* إضافة محاضرة */}
            <div className="mb-6">
              <h4 className="font-bold mb-2">إضافة محاضرة</h4>
              <button
                onClick={() => setShowAddLectureModal(true)}
                className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
              >
                إضافة محاضرة جديدة
              </button>
            </div>

            {/* إضافة سؤال اختبار */}
            <div className="mb-6">
              <h4 className="font-bold mb-2">إضافة سؤال اختبار</h4>
              <button
                onClick={() => setShowAddQuizModal(true)}
                className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg"
              >
                إضافة سؤال جديد
              </button>
            </div>

            {/* عرض المستويات والمحاضرات */}
            <div>
              <h4 className="font-bold mb-2">المستويات والمحاضرات</h4>
              {Array.isArray(selectedCourse.levels) && selectedCourse.levels.length > 0 ? (
                <div className="space-y-4">
                  {selectedCourse.levels.map(level => (
                    <div key={level.id} className="border border-gray-200 rounded-lg p-4">
                      <h5 className="font-bold">{level.title}</h5>
                      <p className="text-sm text-gray-600">{level.description}</p>
                      <div className="mt-3">
                        <strong>المحاضرات:</strong>
                        <ul className="list-disc list-inside text-sm text-gray-600">
                          {Array.isArray(level.lectures) && level.lectures.length > 0 ? (
                            level.lectures.map(lecture => (
                              <li key={lecture.id}>
                                <a href={lecture.videoUrl} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                                  {lecture.title}
                                </a>
                              </li>
                            ))
                          ) : (
                            <li>لا توجد محاضرات بعد.</li>
                          )}
                        </ul>
                      </div>
                      <div className="mt-3">
                        <strong>الاختبار:</strong>
                        <ul className="list-disc list-inside text-sm text-gray-600">
                          {Array.isArray(level.quiz) && level.quiz.length > 0 ? (
                            level.quiz.map(q => (
                              <li key={q.id}>
                                {q.question} (الإجابة الصحيحة: {q.options[q.correctAnswer]})
                              </li>
                            ))
                          ) : (
                            <li>لا توجد أسئلة اختبار بعد.</li>
                          )}
                        </ul>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p>لا توجد مستويات بعد.</p>
              )}
            </div>
          </div>
        )}
      </main>

      {/* نافذة تعديل الملف الشخصي */}
      {showEditProfileModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
            <h3 className="text-xl font-bold mb-6">تعديل الملف الشخصي</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">الاسم</label>
                <input
                  type="text"
                  value={editTrainer.name}
                  onChange={(e) => setEditTrainer({ ...editTrainer, name: e.target.value })}
                  className="w-full border border-gray-300 rounded-lg px-4 py-2"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">البريد الإلكتروني</label>
                <input
                  type="email"
                  value={editTrainer.email}
                  onChange={(e) => setEditTrainer({ ...editTrainer, email: e.target.value })}
                  className="w-full border border-gray-300 rounded-lg px-4 py-2"
                  disabled
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف</label>
                <input
                  type="tel"
                  value={editTrainer.phone}
                  onChange={(e) => setEditTrainer({ ...editTrainer, phone: e.target.value })}
                  className="w-full border border-gray-300 rounded-lg px-4 py-2"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">الوصف الشخصي</label>
                <textarea
                  value={editTrainer.bio}
                  onChange={(e) => setEditTrainer({ ...editTrainer, bio: e.target.value })}
                  className="w-full border border-gray-300 rounded-lg px-4 py-2"
                  rows="3"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">رابط صورة المدرب</label>
                <input
                  type="url"
                  value={editTrainer.avatar}
                  onChange={(e) => setEditTrainer({ ...editTrainer, avatar: e.target.value })}
                  className="w-full border border-gray-300 rounded-lg px-4 py-2"
                />
              </div>
            </div>
            <div className="flex justify-end gap-3 mt-6">
              <button
                onClick={() => setShowEditProfileModal(false)}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                إلغاء
              </button>
              <button
                onClick={handleEditProfile}
                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
              >
                حفظ التعديلات
              </button>
            </div>
          </div>
        </div>
      )}

      {/* نافذة تغيير كلمة المرور */}
      {showChangePasswordModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full">
            <h3 className="text-xl font-bold mb-6">تغيير كلمة المرور</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">كلمة المرور الحالية</label>
                <input
                  type="password"
                  value={currentPassword}
                  onChange={(e) => setCurrentPassword(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg px-4 py-2"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">كلمة المرور الجديدة</label>
                <input
                  type="password"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg px-4 py-2"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">تأكيد كلمة المرور الجديدة</label>
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg px-4 py-2"
                />
              </div>
            </div>
            <div className="flex justify-end gap-3 mt-6">
              <button
                onClick={() => setShowChangePasswordModal(false)}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                إلغاء
              </button>
              <button
                onClick={handleChangePassword}
                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
              >
                تغيير كلمة المرور
              </button>
            </div>
          </div>
        </div>
      )}

      {/* النماذج الأخرى (إضافة مستوى، محاضرة، اختبار، تعديل دورة) كما هي */}
      {/* يمكنك نسخها من الكود السابق */}
    </div>
  );
};

export default TrainerDashboard;